<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>

    <!-- Tailwind CSS v3 Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- Flowbite CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.2"></script>

    <!-- Dark mode toggle script -->
    <script>
        // On page load, check localStorage and apply theme BEFORE page renders
        const savedTheme = localStorage.getItem('color-theme');

        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
            if (!savedTheme) {
                localStorage.setItem('color-theme', 'light');
            }
        }
    </script>

    <script>
        // After DOM loads, set up the toggle button
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }

            themeToggleBtn.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                themeToggleDarkIcon.classList.toggle('hidden');
                themeToggleLightIcon.classList.toggle('hidden');

                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    localStorage.setItem('color-theme', 'light');
                }
            });
        });
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0">
            <div class="p-4 sticky top-0">
                <!-- Header with Logo -->
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                        <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">Flowbite-HTMY</a>
                    </h1>

                    <!-- Dark mode toggle button -->
                    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2">
                        <svg id="theme-toggle-dark-icon" class="hidden w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

                <!-- Navigation Menu -->
                <nav class="space-y-1">
                    {{ navigation | safe }}
                </nav>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                {{ content | safe }}
            </div>
        </main>
    </div>

    <!-- Flowbite JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    <!-- Initialize Flowbite components -->
    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // --- START: MODAL INITIALIZATION ---
            // Flowbite 3.x requires explicit modal initialization (not automatic like earlier versions).
            // Find all modal elements and create Modal instances to register them in Flowbite's instance registry.
            // This allows data-modal-toggle and data-modal-hide buttons to work correctly.

            document.querySelectorAll('[id$="-modal"]').forEach(function(modalEl) {
                if (typeof Modal !== 'undefined') {
                    const modal = new Modal(modalEl, {
                        backdrop: modalEl.getAttribute('data-modal-backdrop') || 'dynamic',
                        closable: true,
                    });
                    console.log('âœ“ Initialized modal:', modalEl.id);
                } else {
                    console.error('Flowbite Modal class not available');
                }
            });

            console.log('âœ“ Modal initialization complete');
            // --- END: MODAL INITIALIZATION ---

            // --- START: DRAWER INITIALIZATION ---
            // Explicitly initialize drawers (Flowbite 3.x has buggy auto-init that adds conflicting classes)
            // Similar pattern to modals - find drawer elements and create instances

            document.querySelectorAll('[id^="drawer-"]').forEach(function(drawerEl) {
                // Skip label elements
                if (drawerEl.id.endsWith('-label')) return;

                if (typeof Drawer !== 'undefined') {
                    // Create instance without options - let it read from data attributes
                    const drawer = new Drawer(drawerEl);
                    console.log('âœ“ Initialized drawer:', drawerEl.id);
                } else {
                    console.error('Flowbite Drawer class not available');
                }
            });

            console.log('âœ“ Drawer initialization complete');
            // --- END: DRAWER INITIALIZATION ---
        });

        // Toast management configuration
        const TOAST_CONFIG = {
            maxToasts: 5,           // Maximum toasts in container
            autoDismissDelay: 5000  // Auto-dismiss after 5 seconds (0 = disabled)
        };

        // Listen for server-triggered initialization via HX-Trigger-After-Settle header
        // Server passes the exact toast_id to initialize - no DOM scanning needed!
        document.body.addEventListener("initialize_toast_dismiss", function(evt) {
            const toastId = evt.detail.toast_id;

            if (!toastId) {
                console.warn('No toast_id provided in initialize_toast_dismiss event');
                return;
            }

            // Find the specific toast by ID (server told us exactly which one)
            const targetEl = document.getElementById(toastId);
            if (!targetEl) {
                console.warn('Toast not found:', toastId);
                return;
            }

            // Find dismiss button in this specific toast
            const dismissTrigger = targetEl.querySelector('[data-dismiss-target]');
            if (!dismissTrigger) {
                console.warn('No dismiss button in toast:', toastId);
                return;
            }

            // Check if already initialized (prevent duplicates)
            if (dismissTrigger.hasAttribute('data-dismiss-initialized')) {
                console.log('Toast already initialized, skipping:', toastId);
                return;
            }

            // Create Dismiss instance for this specific toast
            if (typeof Dismiss !== 'undefined') {
                const dismissInstance = new Dismiss(targetEl, dismissTrigger);
                dismissTrigger.setAttribute('data-dismiss-initialized', 'true');
                console.log('âœ“ Initialized dismiss via server trigger:', toastId);

                // Auto-dismiss after delay (if enabled)
                if (TOAST_CONFIG.autoDismissDelay > 0) {
                    setTimeout(function() {
                        if (targetEl && getComputedStyle(targetEl).display !== 'none') {
                            dismissInstance.hide();
                            console.log('â± Auto-dismissed toast:', toastId);
                        }
                    }, TOAST_CONFIG.autoDismissDelay);
                }
            }

            // Enforce max toasts limit
            enforceMaxToasts();
        });

        // Enforce maximum number of toasts in container
        function enforceMaxToasts() {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toasts = Array.from(container.querySelectorAll('[role="alert"]'))
                .filter(toast => getComputedStyle(toast).display !== 'none');

            if (toasts.length > TOAST_CONFIG.maxToasts) {
                // Remove oldest toasts (from the end, since we use afterbegin)
                const toastsToRemove = toasts.slice(TOAST_CONFIG.maxToasts);
                toastsToRemove.forEach(function(toast) {
                    toast.style.display = 'none';
                    console.log('ðŸ—‘ Removed old toast (max limit):', toast.id);
                });
            }
        }
    </script>
</body>
</html>
